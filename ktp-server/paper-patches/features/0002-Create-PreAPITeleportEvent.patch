From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Bjarne Koll <git@lynxplay.dev>
Date: Tue, 20 May 2025 01:12:10 +0200
Subject: [PATCH] Create PreAPITeleportEvent

As spigot api teleportation is subject to stricter checks than the
default minecraft teleportation, some plugins may not be able to
teleport entities that would be perfectly fine teleporting under the
vanilla standart.

To not remove the created rules by spigot and potentially break plugin
compatibility the PreAPITeleportEvent is called prior to most checks
executed by spigot which allows plugins to modify potential target
entities that are teleported by other plugins prior to the checks.

diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index 316302320b6b4b1b3d0e9545f37dbc5656dc6676..539161012e28c23d59dfd381e8129072b2c0a85d 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -296,6 +296,9 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         // Paper end
         Preconditions.checkArgument(location != null, "location cannot be null");
         location.checkFinite();
+        // KTP start - Call pre api teleport / move dead check above event to respect definition of event
+        new dev.lynxplay.ktp.event.server.PreAPITeleportEvent(this, this.getLocation(), location.clone(), cause).callEvent();
+        // KTP end
         // Paper start - Teleport passenger API
         Set<io.papermc.paper.entity.TeleportFlag> flagSet = new HashSet<>(List.of(flags)); // Wrap into list while multiple old flags link to the same new one
         boolean dismount = !flagSet.contains(io.papermc.paper.entity.TeleportFlag.EntityState.RETAIN_VEHICLE);
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 975bc2bf7c19208a524cbd828e66c8eb60953aca..8a78eba6647cd794fd9dd6b6993c2aedde532348 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1362,6 +1362,9 @@ public class CraftPlayer extends CraftHumanEntity implements Player, PluginMessa
         if (this.getHealth() == 0 || entity.isRemoved()) {
             return false;
         }
+        // KTP start - Call pre api teleport
+        new dev.lynxplay.ktp.event.server.PreAPITeleportEvent(this, this.getLocation(), location.clone(), cause).callEvent();
+        // KTP end
 
         if (entity.connection == null) {
             return false;
