From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Bjarne Koll <git@lynxplay.dev>
Date: Tue, 20 May 2025 01:12:10 +0200
Subject: [PATCH] Create PreAPITeleportEvent

As spigot api teleportation is subject to stricter checks than the
default minecraft teleportation, some plugins may not be able to
teleport entities that would be perfectly fine teleporting under the
vanilla standart.

To not remove the created rules by spigot and potentially break plugin
compatibility the PreAPITeleportEvent is called prior to most checks
executed by spigot which allows plugins to modify potential target
entities that are teleported by other plugins prior to the checks.

diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index b177e23db960323b901909a3f845a9ae0426d0df..8a4f4254fcde2ef7386e50a00b8cd015d827f543 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -301,6 +301,9 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         if (!entity.isAlive() || !entity.valid) {
             return false;
         }
+        // KTP start - Call pre api teleport / move dead check above event to respect definition of event
+        new dev.lynxplay.ktp.event.server.PreAPITeleportEvent(this, this.getLocation(), location.clone(), cause).callEvent();
+        // KTP end - Call pre api teleport / move dead check above event to respect definition of event
 
         final Set<net.minecraft.world.entity.Relative> relativeFlags = EnumSet.noneOf(net.minecraft.world.entity.Relative.class);
         for (final TeleportFlag flag : flags) {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 436ae42b4ef226b4867abd65086ad0e20ff8598d..810f0caedc78fa716b88fabc97624ddfc4536bfc 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -1300,6 +1300,9 @@ public class CraftPlayer extends CraftHumanEntity implements Player, PluginMessa
         if (this.getHandle().connection == null) {
             return false;
         }
+        // KTP start - Call pre api teleport
+        new dev.lynxplay.ktp.event.server.PreAPITeleportEvent(this, this.getLocation(), location.clone(), cause).callEvent();
+        // KTP end - Call pre api teleport
         // Minecraft does not currently support teleporting players between worlds with passengers.
         // It causes them to be dismounted, and causes weird behavior.
         if (location.getWorld() != this.getWorld() && !this.getHandle().passengers.isEmpty()) {
